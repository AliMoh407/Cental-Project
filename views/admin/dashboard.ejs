<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Car Rental</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <%- include('../partials/header') %>

    <main class="admin-main">
        <!-- Admin Header -->
        <section class="admin-header">
            <div class="admin-header-content">
                <div>
                    <h1 class="admin-title">
                        <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                    </h1>
                    <p class="admin-subtitle">Manage your car rental business</p>
                </div>
                <div class="admin-actions">
                    <a href="/admin/cars/add" class="btn btn-secondary btn-large">
                        <i class="fas fa-plus-circle"></i> Add New Car
                    </a>
                    <button onclick="refreshAll()" class="btn btn-outline btn-large">
                        <i class="fas fa-sync-alt"></i> Refresh All
                    </button>
                </div>
            </div>
        </section>

        <!-- Admin Content -->
        <div class="admin-content">
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon cars">
                            <i class="fas fa-car"></i>
                        </div>
                    </div>
                    <div class="stat-number"><%= cars.length %></div>
                    <div class="stat-label">Total Cars</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon bookings">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>
                    <div class="stat-number"><%= bookings.length %></div>
                    <div class="stat-label">Total Bookings</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon revenue">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-number">$<%= bookings.reduce((total, booking) => total + (booking.price || 0), 0) %></div>
                    <div class="stat-label">Total Revenue</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-number"><%= bookings.filter(b => b.status === 'pending').length %></div>
                    <div class="stat-label">Pending Bookings</div>
                </div>
            </div>

            <!-- Management Sections -->
            <div class="management-sections">
                <!-- Cars Management -->
                <section class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-car"></i> Car Management
                        </h2>
                        <div class="section-actions">
                            <a href="/admin/cars/add" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Car
                            </a>
                            <button onclick="refreshCars()" class="btn btn-outline">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <% if (cars && cars.length > 0) { %>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Vehicle</th>
                                        <th>Year</th>
                                        <th>Price/Day</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cars.forEach(car => { %>
                                        <tr>
                                            <td>
                                                <img src="<%= car.images && car.images.length > 0 ? car.images[0].startsWith('/') ? car.images[0] : '/' + car.images[0] : '/images/default-car.jpg' %>" 
                                                     alt="<%= car.brand %> <%= car.model %>" 
                                                     class="car-thumbnail"
                                                     onerror="this.src='/images/default-car.jpg'">
                                            </td>
                                            <td>
                                                <div>
                                                    <strong><%= car.brand %> <%= car.model %></strong>
                                                    <div style="font-size: 0.875rem; color: var(--gray-500);">
                                                        ID: <%= car._id.toString().substring(0, 8) %>...
                                                    </div>
                                                </div>
                                            </td>
                                            <td><%= car.year %></td>
                                            <td>
                                                <strong style="color: var(--primary-blue);">$<%= car.pricePerDay || car.price %></strong>
                                            </td>
                                            <td>
                                                <span class="status-badge <%= car.available ? 'available' : 'unavailable' %>">
                                                    <i class="fas fa-circle"></i>
                                                    <%= car.available ? 'Available' : 'Unavailable' %>
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="/admin/cars/edit/<%= car._id %>" class="btn-admin primary">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </a>
                                                    <button onclick="toggleCarAvailability('<%= car._id %>', <%= !car.available %>)" 
                                                            class="btn-admin <%= car.available ? 'warning' : 'success' %>">
                                                        <i class="fas fa-toggle-<%= car.available ? 'on' : 'off' %>"></i>
                                                        <%= car.available ? 'Disable' : 'Enable' %>
                                                    </button>
                                                    <button onclick="deleteCar('<%= car._id %>')" class="btn-admin danger">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-car"></i>
                                <h3>No Cars Found</h3>
                                <p>Start by adding your first car to the fleet.</p>
                                <a href="/admin/cars/add" class="btn btn-primary" style="margin-top: var(--spacing-lg);">
                                    <i class="fas fa-plus"></i> Add Your First Car
                                </a>
                            </div>
                        <% } %>
                    </div>
                </section>

                <!-- Bookings Management -->
                <section class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-calendar-check"></i> Booking Management
                        </h2>
                        <div class="section-actions">
                            <button onclick="refreshBookings()" class="btn btn-outline">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <% if (bookings && bookings.length > 0) { %>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Customer</th>
                                        <th>Vehicle</th>
                                        <th>Pickup Date</th>
                                        <th>Return Date</th>
                                        <th>Location</th>
                                        <th>Price</th>
                                        <th>ID Verification</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% bookings.forEach(booking => { %>
                                        <tr>
                                            <td>
                                                <strong style="font-family: monospace; color: var(--primary-blue);">
                                                    #<%= booking._id.toString().substring(0, 8) %>
                                                </strong>
                                            </td>
                                            <td>
                                                <% if (booking.user) { %>
                                                    <div class="customer-info">
                                                        <div class="customer-name">
                                                            <i class="fas fa-user" style="color: var(--primary-blue);"></i>
                                                            <strong><%= booking.user.name %></strong>
                                                        </div>
                                                        <div class="customer-email">
                                                            <i class="fas fa-envelope" style="color: var(--gray-500);"></i>
                                                            <%= booking.user.email %>
                                                        </div>
                                                        <% if (booking.user.isAdmin) { %>
                                                            <span class="admin-badge">
                                                                <i class="fas fa-crown"></i> Admin
                                                            </span>
                                                        <% } %>
                                                    </div>
                                                <% } else { %>
                                                    <div class="customer-info">
                                                        <span style="color: var(--error);">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                            Guest User
                                                        </span>
                                                        <small style="color: var(--gray-500);">User data not available</small>
                                                    </div>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (booking.car) { %>
                                                    <strong><%= booking.car.brand %> <%= booking.car.model %></strong>
                                                <% } else { %>
                                                    <span style="color: var(--error);">Car not found</span>
                                                <% } %>
                                            </td>
                                            <td><%= new Date(booking.pickupDate).toLocaleDateString() %></td>
                                            <td><%= new Date(booking.returnDate).toLocaleDateString() %></td>
                                            <td><%= booking.pickupLocation %></td>
                                            <td>
                                                <strong style="color: var(--success);">$<%= booking.price %></strong>
                                            </td>
                                            <td>
                                                <% if (booking.paymentId && booking.paymentId.idPicture) { %>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <img src="/uploads/id-pictures/<%= booking.paymentId.idPicture %>" 
                                                             alt="ID Document" 
                                                             style="width: 40px; height: 30px; object-fit: cover; border-radius: 4px; border: 2px solid var(--success); cursor: pointer;"
                                                             onclick="showAdminIdModal('/uploads/id-pictures/<%= booking.paymentId.idPicture %>')">
                                                        <span style="color: var(--success); font-size: 0.8em; font-weight: 600;">
                                                            <i class="fas fa-check-circle"></i> Verified
                                                        </span>
                                                    </div>
                                                <% } else { %>
                                                    <span style="color: var(--warning); font-size: 0.8em;">
                                                        <i class="fas fa-exclamation-triangle"></i> No ID
                                                    </span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <span class="status-badge <%= booking.status %>">
                                                    <i class="fas fa-circle"></i>
                                                    <%= booking.status %>
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button onclick="updateStatus('<%= booking._id %>', 'confirmed')" 
                                                            class="btn-admin success"
                                                            <%= booking.status === 'confirmed' ? 'disabled' : '' %>>
                                                        <i class="fas fa-check"></i> Confirm
                                                    </button>
                                                    <button onclick="updateStatus('<%= booking._id %>', 'cancelled')"
                                                            class="btn-admin warning"
                                                            <%= booking.status === 'cancelled' ? 'disabled' : '' %>>
                                                        <i class="fas fa-times"></i> Cancel
                                                    </button>
                                                    <button onclick="deleteBooking('<%= booking._id %>')"
                                                            class="btn-admin danger">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <h3>No Bookings Found</h3>
                                <p>Bookings will appear here once customers start making reservations.</p>
                            </div>
                        <% } %>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- ID Photo Modal -->
    <div id="adminIdModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);">
        <span style="position: absolute; top: 15px; right: 25px; color: white; font-size: 2em; cursor: pointer;" onclick="closeAdminIdModal()">&times;</span>
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
            <img id="adminModalIdImage" src="" alt="ID Document" style="width: 100%; height: auto; border-radius: 0.75rem;">
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        // Enhanced admin functions with better UX
        async function updateStatus(bookingId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus} this booking?`)) return;

            try {
                showLoading();
                const response = await fetch(`/admin/bookings/${bookingId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                hideLoading();
                if (response.ok) {
                    showSuccessMessage(`Booking ${newStatus} successfully!`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showErrorMessage('Failed to update booking status');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showErrorMessage('An error occurred while updating the booking');
            }
        }

        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) return;

            try {
                showLoading();
                const response = await fetch(`/admin/bookings/${bookingId}`, {
                    method: 'DELETE'
                });

                hideLoading();
                if (response.ok) {
                    showSuccessMessage('Booking deleted successfully!');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showErrorMessage('Failed to delete booking');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showErrorMessage('An error occurred while deleting the booking');
            }
        }

        async function deleteCar(carId) {
            if (!confirm('Are you sure you want to delete this car? This action cannot be undone.')) return;

            try {
                showLoading();
                const response = await fetch(`/admin/cars/${carId}`, {
                    method: 'DELETE'
                });

                hideLoading();
                if (response.ok) {
                    showSuccessMessage('Car deleted successfully!');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showErrorMessage('Failed to delete car');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showErrorMessage('An error occurred while deleting the car');
            }
        }

        async function toggleCarAvailability(carId, makeAvailable) {
            const action = makeAvailable ? 'enable' : 'disable';
            if (!confirm(`Are you sure you want to ${action} this car?`)) return;

            try {
                showLoading();
                const response = await fetch(`/admin/cars/${carId}/availability`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ available: makeAvailable })
                });

                hideLoading();
                if (response.ok) {
                    showSuccessMessage(`Car ${action}d successfully!`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showErrorMessage('Failed to update car availability');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showErrorMessage('An error occurred while updating the car availability');
            }
        }
    </script>
</body>
</html>